#영속성 관리
##엔티티 매니저 팩토리와 엔티티 매니저
데이터베이스를 하나만 사용하는 애플리케이션은 일반적으로 EntityManagerFactory를 하나만 생성한다.
다음은 엔티티 매니저 팩토리를 생성하는 코드다.
~~~java
// 공장 만들기, 비용이 아주 많이 든다.
EntityManagerFactory emf =
    Persistence.createEntityManagerFactory("jpabook");
// 이제부터 필요할 때마다 엔티티 매니저 팩토리에서 엔티티 매니저를 생성하면 된다.

// 공장에서 엔티티 매니저 생성, 비용이 거의 안 든다.
EntitiyManager em = emf.createEntityManager();
~~~
엔티티 매니저 팩토리는 여러 스레드가 동시에 접근해도 안전하므로 서로 다른 스레드 간에 공유해도 되지만,

"엔티티 매니저는 여러 스레드가 동시에 접근하면 동시성 문제가 발생하므로 스레드 간에 절대 공유하면 안된다."

## 영속성 컨텍스트란?
JPA를 이해하는 데 가장 중요한 용어는 영속성 컨텍스트(persistence context)다.
'엔티티를 영구 저장하는 환경' 이라는 뜻이다.

`em.persist(member);` persist() 메소드는 엔티티 매니저를 사용해서 회원 엔티티를 영속성 컨텍스트에 저장한다.

영속성 컨텍스르는 논리적인 개념에 가깝고 눈에 보이지도 않는다.

## 엔티티의 생명주기
엔티티에는 4가지 상태가 존재한다.
* **비영속**: 영속성 컨텍스트와 전혀 관계가 없는 상태
* **영속**: 영속성 컨텍스트에 저장된 상태
* **준영속**: 영속성 컨텍스트에 저장되었다가 분리된 상태
* **삭제**: 삭제된 상태

## 영속성 컨텍스트 틍징
영속성 컨텍스트의 특징은 다음과 같다.
### 영속성 컨텍스트와 식별자 값
영속 상태는 식별자 값이 반드시 있어야한다. 없으면 예외가 발생한다.
### 영속성 컨텍스트와 데이터베이스 저장
JPA는 보통 트랜잭션을 커밋하는 순간 영속성 컨텍스트에 새로 저장된 엔티티를 데이터베이스에 반영하는데
이것을 플러시(flush)라 한다.
### 영속성 컨텍스트가 엔티티를 관리하면 다음과 같은 장점이 있다.
* 1차 캐시
* 동일성 보장
* 트랜잭션을 지원하는 쓰기 지연
* 변경 감지
* 지연 로딩

## 플러시
플러시는 영속성 컨텍스트의 변경 내용을 데이터베이스에 반영한다. 플러시를 실행하면 구체적으로 다음과 같은 일이 일어난다.
1. 변경 감지가 동작해서 영속성 컨텍스트에 있는 모든 엔티티를 스냅샷과 비교해서 수정된 엔티티를 찾는다. 수정된 엔티티는 수정 쿼리를 만들어 쓰기 지연 SQL 저장소에 등록한다.
2. 쓰기 지연 SQL 저장소의 쿼리를 데이터베이스에 전송한다.

